---
title: "Yanny-Laurel Analysis, II"
output:
  html_document:
    df_print: paged
---
## Analysis, Continued!
Alright, so we've evaluated our main hypothesis in the last script (whether dB level, and also individual factors affect the proportion of times participants hear "Yanny" over "Laurel"). 

Now let's look at reaction times to evaluate our secondary hypothesis, that smaller dB ratios will yield longer RTs. 

First, setup the script...

### Set paths and load libraries
```{r}
data_path = file.path('../data') 
results_path = file.path('../3_results')
stim_path = file.path('../stim')

library(tidyverse)
# Helper functions
source('./helper_functions.R')
```

### Load Data
```{r}
data <- read.csv(file.path(data_path,"data.csv"))
```

## 1. Reaction Times

From our preregistration: 

"We will exclude particularly slow and particularly fast responses, defined as median +- 3 * the median absolute deviation (MAD). However if this procedure eliminates more than 5% of observations, we will opt for a factor to multiply the MAD by, that allows for retention of at least 95% of the data."

#### Outlier removal
```{r}
hist(data$RT)
summary(data$RT)

too_short <- which(data$RT<median(data$RT)-3*mad(data$RT)) 
too_long <- which(data$RT>median(data$RT)+3*mad(data$RT))
data2 <- data[-too_long,]
length(data2$RT)/length(data$RT)

#data_or <- data[???,]

#ggplot() +
#   geom_histogram(data, mapping = aes(RT), fill = 'lightblue', alpha = 0.8) + 
#   geom_histogram(data_or, mapping = aes(RT), fill = 'orange', alpha = 0.5)
```

#### Summary statistics
Let's look at some summary statistics:
```{r}
summary(data_or$RT)
```

How do we expect the data to look, broken down by participant and dB level?
```{r}
RTdata <- data_or %>% group_by(participant, dB_ratio) %>%
                  summarise(median = median(RT),
                            mad = mad(RT),
                            quant = IQR(RT))

```


#### Plot
We'll use [geom_boxplot()](https://ggplot2.tidyverse.org/reference/geom_boxplot.html) to visualize the summary statistics of RTs for each level of our dB manipulation. 

We'll also visualize the raw data by plotting the points with geom_point(). 

```{r}
ggplot(data_or) + 
   geom_boxplot(aes(dB_ratio, RT, group = dB_ratio))# + 
#   geom_point(aes(dB_ratio, RT)) 
```
Challenge! Use [Raincloud](https://github.com/RainCloudPlots/RainCloudPlots) plots to also add a "half violin" to the side of each boxplot. Then, you'll be visualizing the raw data, summary stats, and the distribution of responses for each level of dB. 


### 2. Plain Linear Regression

Now, we're going to model the effect of dB level (or stim_idx, doesn't matter here...).
What happens if we do a simple linear regression?
```{r}
RTmodel1 <- lm(RT ~ stim_idx, data = data_or)

summary(RTmodel1)

plot(resid(RTmodel1))
hist(resid(RTmodel1))

predicted <- data.frame(RT_pred = predict(RTmodel1, data_or), dB_ratio=data_or$dB_ratio)

ggplot(data_or, aes(dB_ratio, RT)) +
  geom_pointrange(stat = "summary",
               fun.min = function(z) {quantile(z,0.25)},
               fun.max = function(z) {quantile(z,0.75)},
               fun = median) +
  geom_line(color='red',data = predicted, aes(x=dB_ratio, y=RT_pred)) + 
  stat_smooth(method='lm', formula = y ~ x, size = 1) 


```

### 3. Polynomial Regression
So let's give it a try:
```{r}
#RTmodel2 <- lm(RT ~ poly(stim_idx,???), data = data_or)

summary(RTmodel2)

hist(resid(RTmodel2))

predicted2 <- data.frame(RT_pred = predict(RTmodel2, data_or), dB_ratio=data_or$dB_ratio)

# ggplot(data_or, aes(dB_ratio, RT)) +
#   geom_pointrange(stat = "summary",
#                fun.min = function(z) {quantile(z,0.25)},
#                fun.max = function(z) {quantile(z,0.75)},
#                fun = median) +
#   geom_line(color='red',data = predicted2, aes(x=dB_ratio, y=RT_pred)) + 
#   stat_smooth(method='lm', formula = y ~ poly(x,2), size = 1) 


```

```{r}
#confint(RTmodel2, level=0.95)
```
How do we interpret the polynomial coefficients? 

The predicted reaction time for a given dB level is given by the following equation:

RT = the intercept + first order polynomial* (dB level) + second order polynomial* (dB level)^2

### Model Comparison
```{r}
anova(RTmodel1, RTmodel2, test = "Chisq")
```


### Writing it up... 
[Values](https://www.statisticssolutions.com/reporting-statistics-in-apa-format/) to report: R^2, F value (F), degrees of freedom (numerator, denominator; in parentheses separated by a comma next to F), and significance level (p), β. Report the β and the corresponding t-test for that predictors for each predictor in the regression

For Example:
"A polynomial regression analysis was used to test if the dB ratio level significantly
predicted participants' reaction times to the Yanny/Laurel 2AFC task. The results of the regression indicated the predictor "dB ratio" explained __ % of the variance (R2 = __, F( __,__)=__, p __ ). It was found that __ [did not/significantly predict/ed RT (β = __, p __ )." 


### Bonus: GLM with specified family
```{r}
# install.packages("lme4")
# library(lme4)
# RTmodel3 <- glmer(RT ~ stim_idx + (1|participant), data=data_or, family = ???)
# 
# summary(RTmodel3)
# 
# hist(resid(RTmodel3))
# 
# predicted3 <- data.frame(RT_pred = predict(RTmodel3, data_or, type = "response"), participant = data_or$participant, dB_ratio=data_or$dB_ratio)
# 
# ggplot(data_or, aes(dB_ratio, RT)) +
#   geom_point(aes(color = as.factor(participant))) +
#   geom_line(color='red',data = predicted3, aes(x=dB_ratio, y=RT_pred))# + 
#   #stat_smooth(method='glm', formula = y ~ poly(x,2), size = 1) 

```


# Resources
A great reference for modelling RTs [here.](https://lindeloev.github.io/shiny-rt/#1_opinion:_three_important_types_of_parameters)